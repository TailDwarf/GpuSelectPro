drop table temp1;
drop table temp2;
drop table temp3;
drop table ZNMAT105;
CREATE  TABLE ZNMAT105 (MANDT VARCHAR(3)  ,PERIO VARCHAR(7) ,SEQNR VARCHAR(50)  ,RULEID_FQ VARCHAR(50)  ,RULEID VARCHAR(50)  ,COKEY VARCHAR(50)  ,VRGAR VARCHAR(2)  ,VERSION VARCHAR(3)  ,SEQNR_SPR VARCHAR(50)  ,SEQNR_ROT VARCHAR(50)  ,RULEID_SPR VARCHAR(50)  ,RULEID_SND VARCHAR(50)  ,DATYPE VARCHAR(2)  ,IFDONE VARCHAR(1)  ,KEY_ORGANCOD VARCHAR(50)  ,KEY_LINECOD VARCHAR(120)  ,KEY_CUSTMCACOD VARCHAR(50)  ,KEY_PRDNO VARCHAR(50)  ,FTYNAM_RL VARCHAR(24)  ,FTYNAM_ST VARCHAR(24)  ,FACTORYWET VARCHAR(3) ,FACTORYID VARCHAR(14)  ,KM VARCHAR(10)  ,CRNSCOD VARCHAR(5)  ,OPEXTYP VARCHAR(50)  ,ZFLOGO VARCHAR(50)  ,BJGTLINES VARCHAR(50)  ,SECTOR VARCHAR(50)  ,CBFTCODE VARCHAR(50)  ,GENERALACNT VARCHAR(50)  ,ACNTAGE VARCHAR(50)  ,OPTNAGE VARCHAR(50)  ,ORGANTYP VARCHAR(50)  ,ORGANCOD VARCHAR(50)  ,BUZNSNTURE VARCHAR(50)  ,SPECIALCODE VARCHAR(50)  ,CHANNEL VARCHAR(50)  ,LINETYP VARCHAR(50)  ,LINECOD VARCHAR(120)  ,ABJGTLINES VARCHAR(120)  ,COBASEDPRO VARCHAR(50)  ,MAKTPRO VARCHAR(50)  ,CUSTMNO VARCHAR(50)  ,CUSTMCATYP VARCHAR(50)  ,CUSTMCACOD VARCHAR(50)  ,STAFFNO VARCHAR(50)  ,PRDTYP VARCHAR(50)  ,PRDNO VARCHAR(50)  ,REVONUM VARCHAR(50)  ,ACNTNUMONLY VARCHAR(50)  ,BEASID VARCHAR(50)  ,SELIID VARCHAR(50)  ,OPEXPENSES DOUBLE,CUSBNDNUM DOUBLE,SECTORNUM DOUBLE,CVSNUM DOUBLE,SSBANK DOUBLE,DEVICES DOUBLE,INVEBAPR DOUBLE,REVECST DOUBLE,COST_OP DOUBLE,TOTALINCM DOUBLE,INTERESTIN DOUBLE,CSTCAPITAL DOUBLE,VALCAPITAL DOUBLE,INTERESTEX DOUBLE,FEECOMIN DOUBLE,FEECOMEX DOUBLE,REINVES DOUBLE,VALUEGAINS DOUBLE,EXCHANGE DOUBLE,REBZNSO DOUBLE,PFABLITY DOUBLE,MOVEAC DOUBLE,ACNTNUM DOUBLE,TAMBOAIAO DOUBLE,MOENDBA DOUBLE,MOBGNBA DOUBLE,IOATCRBTTA DOUBLE,BEASSETS DOUBLE,RISKWEASS DOUBLE,TICKETDELS DOUBLE,TICKETRATIO DOUBLE,WKLODEQ DOUBLE,CREDIT DOUBLE,ACNTTIME DOUBLE,LCOT DOUBLE,VOLB DOUBLE,TRANSNUM DOUBLE,APPROVAL DOUBLE,RMBSNUM DOUBLE,RETAILSCO DOUBLE,ELECSCO DOUBLE,CUSTNO DOUBLE,DIFFICULTY DOUBLE,TOTILTIME DOUBLE,INRATECO DOUBLE,LENDERS DOUBLE,BASHET DOUBLE,CAP_SUM DOUBLE,PRDNUM DOUBLE,LOAN_BAL DOUBLE,BAD_LOAN_BAL DOUBLE,PRJ_XM VARCHAR(18)  ,PRJ_SYS VARCHAR(18)  ,PRJ_YJ VARCHAR(18)  ,CJXH VARCHAR(2)  ,BMD_CODE VARCHAR(20)  ,ZIZHU_CODE VARCHAR(20)  ,ACNTAGE_CODE VARCHAR(50)  ,LOBID_MAPRD VARCHAR(18)  ,LOBID_MACUS VARCHAR(18)  ,CATE_CODE VARCHAR(20)  ,HR_SPLIT_FLG VARCHAR(1)  ,SYACNTAGE VARCHAR(50)  ,SYOPTNAGE VARCHAR(20)  ,ZGUEST_GROUP VARCHAR(20)  ) ;
create table temp1(MANDT VARCHAR(3),SEQNR VARCHAR(50),RULEID_SND VARCHAR(50),PERIO VARCHAR(7),SECTOR VARCHAR(50),CBFTCODE VARCHAR(50),ACNTAGE VARCHAR(50),KM VARCHAR(10),BUZNSNTURE VARCHAR(50),OPEXPENSES DOUBLE,GENERALACNT VARCHAR(50),BMD_CODE VARCHAR(20),OPTNAGE VARCHAR(50),CRNSCOD VARCHAR(5),COBASEDPRO VARCHAR(50),CUSTMNO VARCHAR(50),DATYPE VARCHAR(2),SEQNR_SPR VARCHAR(50),SEQNR_ROT VARCHAR(50),BJGTLINES VARCHAR(50));
insert into temp1 select MANDT,SEQNR,RULEID_SND,PERIO,SECTOR,CBFTCODE,ACNTAGE,KM,BUZNSNTURE,OPEXPENSES,GENERALACNT,BMD_CODE,OPTNAGE,CRNSCOD,COBASEDPRO,CUSTMNO,DATYPE ,SEQNR_SPR ,SEQNR_ROT,BJGTLINES from ZNMAT011 WHERE PERIO = '2019002' AND IFDONE <> '' AND RULEID_SND = '' AND DATYPE <> 'A0' ;
create table temp2(OPEXPENSES double,SEQNR_SPR VARCHAR(50));
insert into temp2 select sum(OPEXPENSES),SEQNR_SPR from ZNMAT103 WHERE PERIO = '2019002' GROUP BY SEQNR_SPR ;
create table temp3(MANDT VARCHAR(3),SEQNR VARCHAR(50),RULEID VARCHAR(50),PERIO VARCHAR(7),SECTOR VARCHAR(50),CBFTCODE VARCHAR(50),ACNTAGE VARCHAR(50),KM VARCHAR(10),BUZNSNTURE VARCHAR(50),OPEXPENSES DOUBLE,GENERALACNT VARCHAR(25),BMD_CODE VARCHAR(20),OPTNAGE VARCHAR(50),CRNSCOD VARCHAR(5),COBASEDPRO VARCHAR(50),CUSTMNO VARCHAR(50),DATYPE VARCHAR(2),SEQNR_SPR VARCHAR(50),SEQNR_ROT VARCHAR(50),BJGTLINES VARCHAR(50));
INSERT INTO temp3 SELECT temp1.MANDT, concat('GC',temp1.SECTOR,temp1.CBFTCODE) as SEQNR, temp1.RULEID_SND AS RULEID,temp1.PERIO , temp1.SECTOR , temp1.CBFTCODE , temp1.ACNTAGE , temp1.KM , temp1.BUZNSNTURE ,SUM(temp1.OPEXPENSES-IFNULL(temp2.OPEXPENSES, 0)) AS OPEXPENSES, concat('XN',temp1.SEQNR) as GENERALACNT, temp1.BMD_CODE,temp1.OPTNAGE , temp1.CRNSCOD , 'P11020201' , 'DO00000001', 'X3',temp1.SEQNR AS SEQNR_SPR, temp1.SEQNR_ROT AS SEQNR_ROT , temp1.BJGTLINES FROM temp1 left join temp2 on temp1.SEQNR = temp2.SEQNR_SPR GROUP BY temp1.MANDT,concat('GC',temp1.SECTOR,temp1.CBFTCODE),temp1.RULEID_SND,temp1.PERIO,temp1.SECTOR,temp1.CBFTCODE,temp1.ACNTAGE,temp1.KM,temp1.BUZNSNTURE,concat('XN',temp1.SEQNR),temp1.BMD_CODE,temp1.OPTNAGE,temp1.CRNSCOD,temp1.SEQNR,temp1.SEQNR_ROT,temp1.BJGTLINES ;
insert into ZNMAT105(MANDT,SEQNR,RULEID,PERIO,SECTOR,CBFTCODE,ACNTAGE,KM,BUZNSNTURE,OPEXPENSES,GENERALACNT,BMD_CODE, OPTNAGE, CRNSCOD, COBASEDPRO,CUSTMNO, DATYPE, SEQNR_SPR, SEQNR_ROT, BJGTLINES) select MANDT, SEQNR, RULEID, PERIO, SECTOR, CBFTCODE, ACNTAGE, KM, BUZNSNTURE, OPEXPENSES, GENERALACNT, BMD_CODE, OPTNAGE, CRNSCOD, COBASEDPRO,CUSTMNO, DATYPE, SEQNR_SPR, SEQNR_ROT, BJGTLINES from temp3 where OPEXPENSES <> 0 ;
drop table temp1;
drop table temp2;
drop table temp3;