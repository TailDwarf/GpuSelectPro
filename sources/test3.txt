drop table send1;
drop table temp5;
drop table fg;
drop table Y1;
drop table Y2;
drop table Y;
drop table F;
drop table FG1;
drop table FG2;
drop table FG4;
drop table b;
create table Y1(DATYPE VARCHAR(2));
insert into Y1 select DATYPE from ZNMAT088 ;
create table Y2(DATYPE VARCHAR(2),SEQNR VARCHAR(50),OPEXPENSES double);
insert into Y2 select DATYPE,SEQNR,OPEXPENSES from ZNMAT011 WHERE IFDONE = 'Q' AND RULEID_SND = 'HQ_CC2PC_CK_BZ' AND MANDT = '801' ;
 create table Y(SEQNR VARCHAR(50),OPEXPENSES double);
insert into Y select Y2.SEQNR,Y2.OPEXPENSES from Y2 join Y1 on Y2.DATYPE = Y1.DATYPE ;
create table F(SEQNR_SPR VARCHAR(50),OPEXPENSES DOUBLE);
insert into F(SEQNR_SPR,OPEXPENSES) SELECT SEQNR_SPR,SUM(OPEXPENSES) FROM ZNMAT011 WHERE PERIO = '2019002' AND RULEID_SND = 'HQ_CC2PC_CK_BZ' AND DATYPE = 'A3' GROUP BY SEQNR_SPR ;
CREATE  TABLE ZNMAT011 (MANDT VARCHAR(3),PERIO VARCHAR(7),SEQNR VARCHAR(50)  ,RULEID_FQ VARCHAR(50)  ,RULEID VARCHAR(50)  ,COKEY VARCHAR(50)  ,VRGAR VARCHAR(2)  ,VERSION VARCHAR(3)  ,SEQNR_SPR VARCHAR(50)  ,SEQNR_ROT VARCHAR(50)  ,RULEID_SPR VARCHAR(50)  ,RULEID_SND VARCHAR(50)  ,DATYPE VARCHAR(2)  ,IFDONE VARCHAR(1)  ,KEY_ORGANCOD VARCHAR(50)  ,KEY_LINECOD VARCHAR(120)  ,KEY_CUSTMCACOD VARCHAR(50)  ,KEY_PRDNO VARCHAR(50)  ,FTYNAM_RL VARCHAR(24)  ,FTYNAM_ST VARCHAR(24)  ,FACTORYWET VARCHAR(3)  ,FACTORYID VARCHAR(14)  ,KM VARCHAR(10)  ,CRNSCOD VARCHAR(5)  ,OPEXTYP VARCHAR(50)  ,ZFLOGO VARCHAR(50)  ,BJGTLINES VARCHAR(50)  ,SECTOR VARCHAR(50)  ,CBFTCODE VARCHAR(50)  ,GENERALACNT VARCHAR(50)  ,ACNTAGE VARCHAR(50)  ,OPTNAGE VARCHAR(50)  ,ORGANTYP VARCHAR(50)  ,ORGANCOD VARCHAR(50)  ,BUZNSNTURE VARCHAR(50)  ,SPECIALCODE VARCHAR(50)  ,CHANNEL VARCHAR(50)  ,LINETYP VARCHAR(50)  ,LINECOD VARCHAR(120)  ,ABJGTLINES VARCHAR(120)  ,COBASEDPRO VARCHAR(50)  ,MAKTPRO VARCHAR(50)  ,CUSTMNO VARCHAR(50)  ,CUSTMCATYP VARCHAR(50)  ,CUSTMCACOD VARCHAR(50)  ,STAFFNO VARCHAR(50)  ,PRDTYP VARCHAR(50)  ,PRDNO VARCHAR(50)  ,REVONUM VARCHAR(50)  ,ACNTNUMONLY VARCHAR(50)  ,BEASID VARCHAR(50)  ,SELIID VARCHAR(50)  ,OPEXPENSES DOUBLE,CUSBNDNUM DOUBLE,SECTORNUM DOUBLE,CVSNUM DOUBLE,SSBANK DOUBLE,DEVICES DOUBLE,INVEBAPR DOUBLE,REVECST DOUBLE,COST_OP DOUBLE,TOTALINCM DOUBLE,INTERESTIN DOUBLE,CSTCAPITAL DOUBLE,VALCAPITAL DOUBLE,INTERESTEX DOUBLE,FEECOMIN DOUBLE,FEECOMEX DOUBLE,REINVES DOUBLE,VALUEGAINS DOUBLE,EXCHANGE DOUBLE,REBZNSO DOUBLE,PFABLITY DOUBLE,MOVEAC DOUBLE,ACNTNUM DOUBLE,TAMBOAIAO DOUBLE,MOENDBA DOUBLE,MOBGNBA DOUBLE,IOATCRBTTA DOUBLE,BEASSETS DOUBLE,RISKWEASS DOUBLE,TICKETDELS DOUBLE,TICKETRATIO DOUBLE,WKLODEQ DOUBLE,CREDIT DOUBLE,ACNTTIME DOUBLE,LCOT DOUBLE,VOLB DOUBLE,TRANSNUM DOUBLE,APPROVAL DOUBLE,RMBSNUM DOUBLE,RETAILSCO DOUBLE,ELECSCO DOUBLE,CUSTNO DOUBLE,DIFFICULTY DOUBLE,TOTILTIME DOUBLE,INRATECO DOUBLE,LENDERS DOUBLE,BASHET DOUBLE,CAP_SUM DOUBLE,PRDNUM DOUBLE,LOAN_BAL DOUBLE,BAD_LOAN_BAL DOUBLE,PRJ_XM VARCHAR(18)  ,PRJ_SYS VARCHAR(18)  ,PRJ_YJ VARCHAR(18)  ,CJXH VARCHAR(2)  ,BMD_CODE VARCHAR(20)  ,ZIZHU_CODE VARCHAR(20)  ,ACNTAGE_CODE VARCHAR(50)  ,GRPID_LOB VARCHAR(35)  ,GRPID_CUSCAT VARCHAR(35)  ,GRPID_PRDSA VARCHAR(35)  ,LOBID_MAPRD VARCHAR(18)  ,LOBID_MACUS VARCHAR(18)  ,CUSCAT_MAIN VARCHAR(18)  ,JZZB_VAL DOUBLE,INC_TAX DOUBLE,OPTAX DOUBLE,BSGAP DOUBLE,OTHER_COST DOUBLE,INCOME_OPO DOUBLE,EXPENSE_OPO DOUBLE,BAL_AVG_M DOUBLE,BAL_BW DOUBLE,VOL_AVG_D DOUBLE,EXPENSE_ZCJZSS DOUBLE,VAL_JZSS DOUBLE,CAPITAL_JG DOUBLE,CAPITAL_CRED DOUBLE,RWA_CR DOUBLE,AVG_D_JZSS DOUBLE,BAL_JRZC DOUBLE,AVG_D_JRZC DOUBLE,BAL_BBW DOUBLE,AVG_D_BBW DOUBLE,TRANS_COUNT_SCF_S DOUBLE,TRANS_COUNT_MJ_S DOUBLE,CATE_CODE VARCHAR(20)  ,CUST_CAT VARCHAR(18)  ,SYACNTAGE VARCHAR(50)  ,SYOPTNAGE VARCHAR(20)  ,SYSECTOR VARCHAR(50)  ,SYABJGTLINES VARCHAR(20)  ,SYPRDNO VARCHAR(20)  ,SYCOBASEDPRO VARCHAR(20)  ,SYCUST_CAT_ID VARCHAR(20)  ,SYCUST_CAT_DESC VARCHAR(20)  ,ZYDL VARCHAR(4)  ,ZYLX VARCHAR(10)  ,XMQS VARCHAR(3)  ,ASSET_TOL DOUBLE,LIAB_SUM DOUBLE,PACKCOUNT DOUBLE,ZYZXBM VARCHAR(18) ,CL_FICATION VARCHAR(1)  ,SJORTJ VARCHAR(1)  ,HR_SPLIT_FLG VARCHAR(1)  ) ;
create table FG1(OPEXPENSES DOUBLE,SEQNR VARCHAR(50),SEQNR_SPR VARCHAR(50));
create table FG4(OPEXPENSES DOUBLE,SEQNR VARCHAR(50),SEQNR_SPR VARCHAR(50));
insert into FG4 SELECT ABS(OPEXPENSES),SEQNR,SEQNR_SPR FROM ZNMAT011 WHERE PERIO = '2019002' AND RULEID_SND = 'HQ_CC2PC_CK_BZ' AND DATYPE = 'A3';
insert into FG1 SELECT OPEXPENSES,MIN(SEQNR),SEQNR_SPR FROM FG4 GROUP BY SEQNR_SPR, OPEXPENSES ;
create table FG2(OPEXPENSES DOUBLE,SEQNR_SPR VARCHAR(50));
insert into FG2 select MAX(ABS(OPEXPENSES)),SEQNR_SPR FROM ZNMAT011 WHERE PERIO = '2019002' AND RULEID_SND = 'HQ_CC2PC_CK_BZ' AND DATYPE = 'A3' GROUP BY SEQNR_SPR;
create table FG(SEQNR_SPR VARCHAR(50),OPEXPENSES DOUBLE,SEQNR VARCHAR(50));
insert into FG select DISTINCT FG1.SEQNR_SPR, FG1.OPEXPENSES, FG1.SEQNR FROM FG1 join FG2 on FG1.SEQNR_SPR = FG2.SEQNR_SPR AND FG1.OPEXPENSES = FG2.OPEXPENSES ;
create table B(SEQNR VARCHAR(50),OPEXPENSES DOUBLE,FGOPEXPENSES DOUBLE);
INSERT into B SELECT Y.SEQNR,Y.OPEXPENSES,FG.OPEXPENSES from Y join F on F.SEQNR_SPR = Y.SEQNR join FG on FG.SEQNR_SPR = Y.SEQNR ;
update ZNMAT011 SET ZNMAT011.OPEXPENSES = B.OPEXPENSES from ZNMAT011,B WHERE ZNMAT011.OPEXPENSES = B.FGOPEXPENSES  AND B.SEQNR = ZNMAT011.SEQNR AND ZNMAT011.RULEID_SND = 'HQ_CC2PC_CK_BZ' AND ZNMAT011.PERIO = '2019002';
drop table fg;
drop table Y1;
drop table Y2;
drop table Y;
drop table F;
drop table FG1;
drop table FG2;
drop table FG4;
drop table b;
        