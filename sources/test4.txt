create table temp1(MANDT VARCHAR(3),SEQNR VARCHAR(50),RULEID_SND VARCHAR(50),PERIO VARCHAR(7),SECTOR VARCHAR(50),CBFTCODE VARCHAR(50),ACNTAGE VARCHAR(50),KM VARCHAR(10),BUZNSNTURE VARCHAR(50),OPEXPENSES DOUBLE,GENERALACNT VARCHAR(50),BMD_CODE VARCHAR(20),OPTNAGE VARCHAR(50),CRNSCOD VARCHAR(5),COBASEDPRO VARCHAR(50),CUSTMNO VARCHAR(50),DATYPE VARCHAR(2),SEQNR_SPR VARCHAR(50),SEQNR_ROT VARCHAR(50),BJGTLINES VARCHAR(50))";
insert into temp1 select MANDT,SEQNR,RULEID_SND,PERIO,SECTOR,CBFTCODE,ACNTAGE,KM,BUZNSNTURE,OPEXPENSES,GENERALACNT,BMD_CODE,OPTNAGE,CRNSCOD,COBASEDPRO,CUSTMNO,DATYPE ,SEQNR_SPR ,SEQNR_ROT,BJGTLINES from ZNMAT011 WHERE PERIO = '2019002' AND IFDONE <> '' AND RULEID_SND = '1' AND DATYPE <> 'A0' proc";
create table temp2(OPEXPENSES double,SEQNR_SPR VARCHAR(50));";
insert into temp2 select sum(OPEXPENSES),SEQNR_SPR from ZNMAT103 WHERE PERIO = '2018001' GROUP BY SEQNR_SPR proc;";
create table temp3(MANDT VARCHAR(3),SEQNR VARCHAR(50),RULEID VARCHAR(50),PERIO VARCHAR(7),SECTOR VARCHAR(50),CBFTCODE VARCHAR(50),ACNTAGE VARCHAR(50),KM VARCHAR(10),BUZNSNTURE VARCHAR(50),OPEXPENSES DOUBLE,GENERALACNT VARCHAR(25),BMD_CODE VARCHAR(20),OPTNAGE VARCHAR(50),CRNSCOD VARCHAR(5),COBASEDPRO VARCHAR(50),CUSTMNO VARCHAR(50),DATYPE VARCHAR(2),SEQNR_SPR VARCHAR(50),SEQNR_ROT VARCHAR(50),BJGTLINES VARCHAR(50));";
INSERT INTO temp3 SELECT temp1.MANDT, concat('GC',temp1.SECTOR,temp1.CBFTCODE) as SEQNR, temp1.RULEID_SND AS RULEID,temp1.PERIO , temp1.SECTOR , temp1.CBFTCODE , temp1.ACNTAGE , temp1.KM , temp1.BUZNSNTURE ,SUM(temp1.OPEXPENSES-IFNULL(temp2.OPEXPENSES, 0)) AS OPEXPENSES, concat('XN',temp1.SEQNR) as GENERALACNT, temp1.BMD_CODE,temp1.OPTNAGE , temp1.CRNSCOD , 'P11020201' , 'DO00000001', 'X3',temp1.SEQNR AS SEQNR_SPR, temp1.SEQNR_ROT AS SEQNR_ROT , temp1.BJGTLINES FROM temp1 left join temp2 on temp1.SEQNR = temp2.SEQNR_SPR GROUP BY temp1.MANDT,concat('GC',temp1.SECTOR,temp1.CBFTCODE),temp1.RULEID_SND,temp1.PERIO,temp1.SECTOR,temp1.CBFTCODE,temp1.ACNTAGE,temp1.KM,temp1.BUZNSNTURE,concat('XN',temp1.SEQNR),temp1.BMD_CODE,temp1.OPTNAGE,temp1.CRNSCOD,temp1.SEQNR,temp1.SEQNR_ROT,temp1.BJGTLINES proc";       
insert into ZNMAT103(MANDT, SEQNR, RULEID, PERIO, SECTOR, CBFTCODE, ACNTAGE, KM, BUZNSNTURE, OPEXPENSES, GENERALACNT, BMD_CODE, OPTNAGE, CRNSCOD, COBASEDPRO,CUSTMNO, DATYPE, SEQNR_SPR, SEQNR_ROT, BJGTLINES) select MANDT, SEQNR, RULEID, PERIO, SECTOR, CBFTCODE, ACNTAGE, KM, BUZNSNTURE, OPEXPENSES, GENERALACNT, BMD_CODE, OPTNAGE, CRNSCOD, COBASEDPRO,CUSTMNO, DATYPE, SEQNR_SPR, SEQNR_ROT, BJGTLINES from temp3 where OPEXPENSES <> 0 proc";
drop table temp1;
drop table temp2;
drop table temp3;